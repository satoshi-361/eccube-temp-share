{#
This file is part of EC-CUBE

Copyright(c) EC-CUBE CO.,LTD. All Rights Reserved.

http://www.ec-cube.co.jp/

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.
#}
{% extends 'default_frame.twig' %}

{% set mypageno = 'transfer' %}

{% set body_class = 'mypage' %}
{% set baseInfoRepository = repository('\\Eccube\\Entity\\BaseInfo') %}
{% set shopFee = baseInfoRepository.get().fee|number_format %}

{% block stylesheet %}
    <style>
        .cs-transfer__history tbody {
            font-size: 14px;
        }
        .cs-transfer__history thead .th-remarks {
            padding-left: 50px;
        }

        @media only screen and (max-width: 767px) {
            .cs-transfer__history {
                padding: 15px 0;
                overflow-x: scroll;
            }
            .cs-transfer__history table {
                width: 750px;
                max-width: unset;
            }
            .cs-transfer__history thead .th-remarks {
                padding-left: 20px;
            }
            .cs-transfer__history table td.blog-name {
                width: 300px;
            }
            .cs-transfer__history table td.reward,
            .cs-transfer__history table td.profit {
                width: 75px;
            }
        }
    </style>
{% endblock %}

{% block main %}
    <div class="ec-layoutRole__main">
        <div class="ec-mypageRole">
            <div class="ec-pageHeader">
                <h1>{{ 'front.mypage.title'|trans }}/{{ '売上管理'|trans }}</h1>
            </div>
            {% include 'Mypage/navi.twig' %}
        </div>
        <div class="ec-mypageRole">
            <div class="d-flex cs-transfer__date">
                <form method="get" action="{{ url('mypage_transfer_history') }}" novalidate>
                    <div class="cs-balance"> 合計 <b>{{ app.user.balance|price }}</b> </div>
                    <input type="month" name="transfer_date" value="{{ selectedMonth }}">
                    <button type="submit" class="ec-blockBtn--action">{{ '確認'|trans }}</button>
                </form>
            </div>
            <div class="cs-transfer__history">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>売上日時</th>
                            <th>記事</th>
                            <th>報酬額</th>
                            <th>計算</th>
                            <th class="th-remarks">備考</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for orderItem in pagination %}
                        {% set Product = orderItem.Product %}
                        <tr>
                            <td>{{ orderItem.Order.order_date|date('Y年m月d日') }}</td>
                            <td class="blog-name"><a class="" href="{{ url('product_detail', { id: Product.id }) }}"> {{ Product.name }} </a></td>
                            <td class="reward">
                                {% if orderItem.affiliater is not empty and orderItem.affiliater == app.user.id %}
                                    {{ ( orderItem.price * orderItem.affiliate_reward / 100 )|price }} <span class="plus"> + </span>
                                {% endif %}
                            </td>
                            <td class="profit">
                                {% if Product.Customer.id == app.user.id %}
                                    {% if orderItem.affiliater is not empty and orderItem.affiliater != app.user.id %}
                                        {{ ( orderItem.price * ( 100 - orderItem.affiliate_reward - shopFee ) / 100 )|price }}
                                    {% else %}
                                        {{ ( orderItem.price * ( 100 - shopFee ) / 100 )|price }}
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% if Product.Customer.id == app.user.id %}
                                    {% if orderItem.affiliater is not empty and orderItem.affiliater != app.user.id %}
                                        <p>
                                            <span class="label price"> {{ orderItem.price|price }} </span>
                                            <span class="plus"> + </span> 
                                            <span class="label comment">（記事販売額）</span>
                                        </p>
                                        <p> 
                                            <span class="label price"> {{ ( orderItem.price * orderItem.affiliate_reward / 100 )|price }} </span>
                                            <span class="minus"> - </span>
                                            <span class="label comment">（アフィリエイト）</span>
                                        </p>
                                    {% else %}
                                        <p>
                                            <span class="label price"> {{ orderItem.price|price }} </span>
                                            <span class="plus"> + </span>
                                            <span class="label comment">（記事販売額）</span>
                                        </p>
                                    {% endif %}
                                        <p>
                                            <span class="label price"> {{ (orderItem.price * shopFee / 100)|price }} </span>
                                            <span class="minus"> - </span>
                                            <span class="label comment">（手数料）</span>
                                        </p>
                                {% else %}
                                    <span class="label">販売者：　　
                                        {% if Product.Customer is not empty %}
                                            {{ Product.Customer.nick_name }}
                                        {% else %}
                                            管理者
                                        {% endif %}
                                    </span><br/>
                                    <span style="margin-top: 5px; display: inline-block;" class="label">購⼊者：　　
                                            {{ orderItem.Order.Customer.nick_name }}
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="ec-pagerRole">
                    {% include "transfer_history_pager.twig" with {'pages': pagination.paginationData} %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}
